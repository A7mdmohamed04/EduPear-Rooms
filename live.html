<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELS Live Class</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="style/main.css">
    <link rel="stylesheet" href="style/live.css">
    <!-- JaaS External API -->
    <script src='https://8x8.vc/external_api.js'></script>
</head>
<body>
    <script>
        // Check if user is starting or joining
        const sessionData = JSON.parse(localStorage.getItem('currentSession') || '{}');
        const isHost = sessionData.isHost || false;
        
        if (isHost) {
            // Host UI - show session controls
            document.getElementById('session-title').textContent = sessionData.title;
            document.getElementById('subject-name').textContent = sessionData.subject;
            document.getElementById('user-name').textContent = "Host";
        } else {
            // Participant UI - show join modal
            document.getElementById('join-modal').style.display = 'flex';
        }
    </script>

    <div class="live-container">
        <header class="live-header">
            <div class="logo">
                <a href="home.html">
                    <i class="fas fa-arrow-left"></i> Back to Home
                </a>
            </div>
            <div class="session-info">
                <h1 id="session-title">Live Class Session</h1>
                <p id="session-details">Subject: <span id="subject-name">Loading...</span></p>
            </div>
            <div class="user-status">
                <span id="connection-status"><i class="fas fa-signal"></i> Connected</span>
                <span id="user-name"></span>
            </div>
        </header>

        <main class="live-content">
            <div class="video-container" id="jaas-container">
                <!-- JaaS will create the video interface here -->
            </div>

            <div class="side-panel">
                <div class="participants-section">
                    <h3><i class="fas fa-users"></i> Participants</h3>
                    <div class="participants-list" id="participants-list">
                        <!-- Participants will be added here dynamically -->
                    </div>
                </div>

                <div class="chat-section">
                    <h3><i class="fas fa-comment-alt"></i> Chat</h3>
                    <div class="chat-messages" id="chat-messages">
                        <!-- Chat messages will appear here -->
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chat-text" placeholder="Type a message...">
                        <button id="send-chat"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </main>

        <div class="controls-bar">
            <button class="control-btn" id="mic-btn" title="Toggle Microphone">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="control-btn" id="camera-btn" title="Toggle Camera">
                <i class="fas fa-video"></i>
            </button>
            <button class="control-btn" id="screen-btn" title="Share Screen">
                <i class="fas fa-desktop"></i>
            </button>
            <button class="control-btn" id="raise-hand-btn" title="Raise Hand">
                <i class="fas fa-hand"></i>
            </button>
            <button class="control-btn" id="settings-btn" title="Settings">
                <i class="fas fa-cog"></i>
            </button>
            <button class="control-btn end-call" id="end-call-btn" title="End Call">
                <i class="fas fa-phone-slash"></i> End
            </button>
        </div>
    </div>

    <!-- Modal for joining -->
    <div class="modal" id="join-modal">
        <div class="modal-content">
            <h2>Join Live Session</h2>
            <div class="form-group">
                <label for="display-name">Your Display Name</label>
                <input type="text" id="display-name" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label for="session-code">Session Code</label>
                <input type="text" id="session-code" placeholder="Enter session code">
            </div>
            <div class="form-actions">
                <button id="join-session-btn" class="primary-btn">Join Session</button>
            </div>
        </div>
    </div>

    <!-- Modal for session settings -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <h2>Session Settings</h2>
            <div class="settings-section">
                <h3>Audio & Video</h3>
                <div class="form-group">
                    <label for="audio-input">Microphone</label>
                    <select id="audio-input">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="video-input">Camera</label>
                    <select id="video-input">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="audio-output">Speaker</label>
                    <select id="audio-output">
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
            </div>
            <div class="settings-section">
                <h3>Display</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="show-names">
                        Show participant names
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="hide-non-video">
                        Hide participants without video
                    </label>
                </div>
            </div>
            <div class="form-actions">
                <button id="save-settings" class="primary-btn">Save Settings</button>
                <button id="close-settings" class="secondary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="js/app.js"></script>
    <script src="js/live.js"></script>
    <script>
        // Initialize JaaS when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Show join modal by default
            document.getElementById('join-modal').style.display = 'flex';
            
            // Join session button click handler
            document.getElementById('join-session-btn').addEventListener('click', function() {
                const displayName = document.getElementById('display-name').value;
                const sessionCode = document.getElementById('session-code').value;
                
                if (!displayName) {
                    alert('Please enter your display name');
                    return;
                }
                
                // Hide the join modal
                document.getElementById('join-modal').style.display = 'none';
                
                // Set the user name in the UI
                document.getElementById('user-name').textContent = displayName;
                
                // Initialize JaaS with the session code
                initializeJaas(displayName, sessionCode);
            });
            
            // Settings button click handler
            document.getElementById('settings-btn').addEventListener('click', function() {
                document.getElementById('settings-modal').style.display = 'flex';
            });
            
            // Close settings modal
            document.getElementById('close-settings').addEventListener('click', function() {
                document.getElementById('settings-modal').style.display = 'none';
            });
            
            // Control buttons functionality
            document.getElementById('mic-btn').addEventListener('click', toggleMicrophone);
            document.getElementById('camera-btn').addEventListener('click', toggleCamera);
            document.getElementById('screen-btn').addEventListener('click', toggleScreenShare);
            document.getElementById('raise-hand-btn').addEventListener('click', raiseHand);
            document.getElementById('end-call-btn').addEventListener('click', endCall);
            
            // Chat functionality
            document.getElementById('send-chat').addEventListener('click', sendChatMessage);
            document.getElementById('chat-text').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
        });
        
        // JaaS API integration
        let api;
        
        function initializeJaas(displayName, roomName) {
            const domain = '8x8.vc';
            const options = {
                roomName: roomName || sessionData.code,
                width: '100%',
                height: '100%',
                parentNode: document.getElementById('jaas-container'),
                configOverwrite: {
                    prejoinPageEnabled: false,
                    disableDeepLinking: true,
                    startWithAudioMuted: true,
                    startWithVideoMuted: true
                },
                interfaceConfigOverwrite: {
                    TOOLBAR_BUTTONS: [],
                    SHOW_JITSI_WATERMARK: false,
                    DEFAULT_REMOTE_DISPLAY_NAME: 'Participant'
                },
                userInfo: {
                    displayName: displayName
                }
            };
            
            if (isHost) {
                // Host-specific configurations
                options.configOverwrite = {
                    ...options.configOverwrite,
                    startWithAudioMuted: false,
                    startWithVideoMuted: false,
                    enableNoisyMicDetection: false
                };
            } else {
                // Participant configurations
                options.configOverwrite = {
                    ...options.configOverwrite,
                    startWithAudioMuted: true,
                    startWithVideoMuted: true
                };
            }
            
            api = new JitsiMeetExternalAPI(domain, options);
            
            // Event listeners
            api.addListener('videoConferenceJoined', handleVideoConferenceJoined);
            api.addListener('participantJoined', handleParticipantJoined);
            api.addListener('participantLeft', handleParticipantLeft);
            api.addListener('chatReceived', handleChatReceived);
            api.addListener('readyToClose', handleReadyToClose);
        }
        
        function handleVideoConferenceJoined(event) {
            console.log('Joined conference', event);
            document.getElementById('subject-name').textContent = event.roomName;
            
            // Update UI to show we're connected
            document.getElementById('connection-status').innerHTML = '<i class="fas fa-signal"></i> Connected';
        }
        
        function handleParticipantJoined(event) {
            console.log('Participant joined', event);
            
            // Add participant to the list
            const participantsList = document.getElementById('participants-list');
            const participantElement = document.createElement('div');
            participantElement.className = 'participant';
            participantElement.id = `participant-${event.id}`;
            participantElement.innerHTML = `
                <span class="participant-name">${event.displayName}</span>
                <span class="participant-status"><i class="fas fa-circle"></i></span>
            `;
            participantsList.appendChild(participantElement);
        }
        
        function handleParticipantLeft(event) {
            console.log('Participant left', event);
            
            // Remove participant from the list
            const participantElement = document.getElementById(`participant-${event.id}`);
            if (participantElement) {
                participantElement.remove();
            }
        }
        
        function handleChatReceived(event) {
            console.log('Chat received', event);
            
            // Add message to chat
            const chatMessages = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            messageElement.innerHTML = `
                <span class="message-sender">${event.from}</span>
                <span class="message-text">${event.message}</span>
                <span class="message-time">${new Date().toLocaleTimeString()}</span>
            `;
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function handleReadyToClose() {
            console.log('Conference ended');
            window.location.href = 'dashboard.html';
        }
        
        function toggleMicrophone() {
            if (api) {
                api.executeCommand('toggleAudio');
                const micBtn = document.getElementById('mic-btn');
                if (micBtn.classList.contains('active')) {
                    micBtn.classList.remove('active');
                    micBtn.querySelector('i').className = 'fas fa-microphone';
                } else {
                    micBtn.classList.add('active');
                    micBtn.querySelector('i').className = 'fas fa-microphone-slash';
                }
            }
        }
        
        function toggleCamera() {
            if (api) {
                api.executeCommand('toggleVideo');
                const cameraBtn = document.getElementById('camera-btn');
                if (cameraBtn.classList.contains('active')) {
                    cameraBtn.classList.remove('active');
                    cameraBtn.querySelector('i').className = 'fas fa-video';
                } else {
                    cameraBtn.classList.add('active');
                    cameraBtn.querySelector('i').className = 'fas fa-video-slash';
                }
            }
        }
        
        function toggleScreenShare() {
            if (api) {
                api.executeCommand('toggleShareScreen');
                const screenBtn = document.getElementById('screen-btn');
                screenBtn.classList.toggle('active');
            }
        }
        
        function raiseHand() {
            if (api) {
                api.executeCommand('toggleRaiseHand');
                const raiseHandBtn = document.getElementById('raise-hand-btn');
                raiseHandBtn.classList.toggle('active');
            }
        }
        
        function endCall() {
            if (api) {
                api.executeCommand('hangup');
            }
            window.location.href = 'dashboard.html';
        }
        
        function sendChatMessage() {
            const chatInput = document.getElementById('chat-text');
            const message = chatInput.value.trim();
            
            if (message && api) {
                api.executeCommand('sendChatMessage', message);
                
                // Add our own message to the chat (JaaS doesn't echo our own messages)
                const chatMessages = document.getElementById('chat-messages');
                const messageElement = document.createElement('div');
                messageElement.className = 'chat-message own-message';
                messageElement.innerHTML = `
                    <span class="message-sender">You</span>
                    <span class="message-text">${message}</span>
                    <span class="message-time">${new Date().toLocaleTimeString()}</span>
                `;
                chatMessages.appendChild(messageElement);
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Clear input
                chatInput.value = '';
            }
        }
    </script>
</body>
</html>
